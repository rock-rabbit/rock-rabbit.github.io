<!DOCTYPE html>
<html lang="zh-cn">
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark" />
    <title>MySQL8 的新特性：NoSQL、索引、账户管理、窗口函数... | 赵登睿的博客 - 济南独立软件开发者</title>

     

    <meta name="keywords" content="rockrabbit,赵登睿,赵登睿博客" />
    <meta property="og:site_name" content="rockrabbit 的博客，分享技术、成长和生活。" />
    <meta property="og:title" content="MySQL8 的新特性：NoSQL、索引、账户管理、窗口函数..." />
    <meta itemprop="name" content="MySQL8 的新特性：NoSQL、索引、账户管理、窗口函数..." />
    <meta name="twitter:title" content="MySQL8 的新特性：NoSQL、索引、账户管理、窗口函数..." />
    <meta name="application-name" content="MySQL8 的新特性：NoSQL、索引、账户管理、窗口函数..." /><meta name="twitter:card" content="summary" />

    <meta name="description"
        content="MySQL8 是 Oracle 公司推出的新款 MySQL Server 版本，有着相比 MYSQL5.7 版本更好的性能以及许多新特性。" />
    <meta name="twitter:description"
        content="MySQL8 是 Oracle 公司推出的新款 MySQL Server 版本，有着相比 MYSQL5.7 版本更好的性能以及许多新特性。 " />
    <meta itemprop="description"
        content=" MySQL8 是 Oracle 公司推出的新款 MySQL Server 版本，有着相比 MYSQL5.7 版本更好的性能以及许多新特性。 " />
    <meta property="og:description"
        content=" MySQL8 是 Oracle 公司推出的新款 MySQL Server 版本，有着相比 MYSQL5.7 版本更好的性能以及许多新特性。 " />

    

<meta property="og:type" content="article" />
<meta property="article:publisher" content="rockrabbit" />
<meta property="og:article:published_time" content=2022-07-05T00:00:00Z />
<meta property="article:published_time" content=2022-07-05T00:00:00Z />


  <meta property="og:article:author" content="不入开发不工作" />
  <meta property="article:author" content="不入开发不工作" />
  <meta name="author" content="不入开发不工作" />




<script defer type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "MySQL8 的新特性：NoSQL、索引、账户管理、窗口函数...",
    "author": {
      "@type": "Person",
      "name": "rockrabbit"
    },
    "datePublished": "2022-07-05",
    "description": "MySQL8 是 Oracle 公司推出的新款 MySQL Server 版本，有着相比 MYSQL5.7 版本更好的性能以及许多新特性。",
    "wordCount":  1165 ,
    "mainEntityOfPage": "True",
    "dateModified": "2022-07-05",
    "publisher": {
      "@type": "Organization",
      "name": "rockrabbit",
      "logo": {
        "@type": "imageObject",
        "url": "https:\/\/www.68wu.cn\/favicon.ico"
      }
    }
  }
</script>


    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" /> 
    <link rel="stylesheet" href="/sass/main.min.13c03f378fb459d5a62a4462b0f5b7fa8d5a865119cf71a64a65d229b594de1f.css" />
    <script async defer data-website-id="bcde5651-ade7-4690-b15a-0f1e3037f9a8" data-domains="www.68wu.cn"
    src="https://umami.68wu.cn/umami.js"></script>
</head>
    
    <script>
        (function() {
            const colorSchemeKey = 'ThemeColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'ThemeColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.userColorScheme = 'dark';
        } else {
            document.documentElement.dataset.userColorScheme = 'light';
        }
    })();
</script>


    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    
                    <img src="/favicon.ico" />
                    
                    rockrabbit 的小屋
                </a>
            </div>
            <div class="flex">
                
                <a href="/projects/" >💾 项目</a>
                
                <a href="/articles/" >📝 文章</a>
                
                
                <button id="dark-mode-button">
                    <svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163 0 1 0 1.643 1.641a1.163 1.163 0 0 0-1.643-1.641zm-16.022 14.38a1.74 1.74 0 0 0 0 2.465a1.742 1.742 0 1 0 0-2.465zm13.968-2.147a2.904 2.904 0 0 1-4.108 0a2.902 2.902 0 0 1 0-4.107a2.902 2.902 0 0 1 4.108 0a2.902 2.902 0 0 1 0 4.107z" fill="#FFCC4D"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    <svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M16 2s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2V2zm18 14s2 0 2 2s-2 2-2 2h-2s-2 0-2-2s2-2 2-2h2zM4 16s2 0 2 2s-2 2-2 2H2s-2 0-2-2s2-2 2-2h2zm5.121-8.707s1.414 1.414 0 2.828s-2.828 0-2.828 0L4.878 8.708s-1.414-1.414 0-2.829c1.415-1.414 2.829 0 2.829 0l1.414 1.414zm21 21s1.414 1.414 0 2.828s-2.828 0-2.828 0l-1.414-1.414s-1.414-1.414 0-2.828s2.828 0 2.828 0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zM16 32s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2v-2z"/><circle fill="#FFD983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                </button>
                
            </div>
        </div>
    </div>
</nav>
        <main>
            
<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>MySQL8 的新特性：NoSQL、索引、账户管理、窗口函数...</h1>
                    <div class="post-meta">
                        <div>
                            
                            
                            作者：不入开发不工作 | <time>发布日期：2022-07-05</time>
                            | 阅读时间：6 分钟
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/mysql/">Mysql</a>
                            
                            <a href="/tags/%E5%BF%AB%E6%8D%B7%E6%89%8B%E5%86%8C/">快捷手册</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
        <h2 id="一新特性概述">
    <a href="#%e4%b8%80%e6%96%b0%e7%89%b9%e6%80%a7%e6%a6%82%e8%bf%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    一、新特性概述
</h2>
<h3 id="11-更简便的-nosql-支持">
    <a href="#11-%e6%9b%b4%e7%ae%80%e4%be%bf%e7%9a%84-nosql-%e6%94%af%e6%8c%81" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.1 更简便的 NoSQL 支持
</h3>
<p><img loading="lazy" 
    src="/mysql8-new-features/b600-mysql-8-mds.en.jpg" 
    alt="b600-mysql-8-mds.en.jpg" 
     
    width=600 
    height="342"  /></p>
<p><code>NoSQL</code> 泛指非关系型数据库和数据存储。随着互联网平台的规模飞速发展，传统的关系型数据库已经越来越不能满足需求。</p>
<p>从 5.6 版本开始，MySQL 就开始支持简单的 NoSQL 存储功能。MySQL8 对这一功能做了优化，以更灵活的方式实现 <code>NosQL</code> 功能，不再依赖模式（schema）。</p>
<h3 id="12-更好的索引">
    <a href="#12-%e6%9b%b4%e5%a5%bd%e7%9a%84%e7%b4%a2%e5%bc%95" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.2 更好的索引
</h3>
<p><img loading="lazy" 
    src="/mysql8-new-features/b600-mysql-8-2x.en.jpg" 
    alt="b600-mysql-8-2x.en.jpg" 
     
    width=600 
    height="341"  /></p>
<p>在查询中，正确地使用索引可以提高查询的效率，MySQL8 中新增了<code>隐藏索引</code>和<code>降序索引</code>，隐藏索引可以用来测试去掉索引对查询性能的影响。在查询中混合存在多列索引时，使用降序索引可以提高查询的性能。</p>
<h3 id="13-更完善的-json-支持">
    <a href="#13-%e6%9b%b4%e5%ae%8c%e5%96%84%e7%9a%84-json-%e6%94%af%e6%8c%81" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.3 更完善的 JSON 支持
</h3>
<p>MySQL 从 5.7 开始支持原生 JSON 数据的存储，MySQL8 对这一功能做了优化，增加了聚合函数<code>JSON_ARRAYAGG()</code> 和 <code>JSON_OBJECTAGG()</code>，将参数聚合为 JSON 数组或对象，新增了行内操作符 <code>-&gt;&gt;</code> ，是列路径运算符 <code>-&gt;</code> 的增强，对 JSON 排序做了提升，并优化了 JSON 的更新操作。</p>
<h3 id="14-安全和账户管理">
    <a href="#14-%e5%ae%89%e5%85%a8%e5%92%8c%e8%b4%a6%e6%88%b7%e7%ae%a1%e7%90%86" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.4 安全和账户管理
</h3>
<p>MySQL8 中新增了 <code>caching_sha2_password</code> 授权插件、角色、密码历史记录和 FIPS 模式支持，这些特性提高了数据库的安全性和性能，使数据库管理员能够更灵活地进行账户管理工作。</p>
<h3 id="15-innodb-的变化">
    <a href="#15-innodb-%e7%9a%84%e5%8f%98%e5%8c%96" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.5 InnoDB 的变化
</h3>
<p>InnoDB 是 MySQL 默认的存储引擎，是事务型数据库的首选引擎，支持事务安全表（ACID），支持行锁定和外键。在 MySQL8 版本中，InnoDB 在自增、索引、加密、死锁、共享锁等方面做了大量的改进和优化，并且支持原子数据定义语言（DDL），提高了数据安全性，对事务提供更好的支持。</p>
<h3 id="16-数据字典">
    <a href="#16-%e6%95%b0%e6%8d%ae%e5%ad%97%e5%85%b8" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.6 数据字典
</h3>
<p>在之前的 MySQL 版本中，字典数据都存储在元数据文件和非事务表中。从 MySQL8 开始新增了事务数据字典，在这个字典里存储着数据库对象信息，这些数据字典存储在内部事务表中。</p>
<h3 id="17-原子数据定义语句">
    <a href="#17-%e5%8e%9f%e5%ad%90%e6%95%b0%e6%8d%ae%e5%ae%9a%e4%b9%89%e8%af%ad%e5%8f%a5" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.7 原子数据定义语句
</h3>
<p>MySQL8 开始支持原子数据定义语句（Automic DDL），即原子 DDL。目前，只有 InnoDB 存储引擎支持原子 DDL。原子数据定义语句（DDL）将与 DDL 操作相关的数据字典更新、存储引擎操作、二进制日志写入结合到一个单独的原子事务中，这使得即使服务器崩溃，事务也会提交或回滚。</p>
<p>使用支持原子操作的存储引擎所创建的表，在执行 <code>DROP TABLE</code>、<code>CREATE TABLE</code>、<code>ALTER TABLE</code>、<code>RENAME TABLE</code>、<code>TRUNCATE TABLE</code>、<code>CREATE TABLESPACE</code>、<code>DROP TABLESPACE</code> 等操作时，都支持原子操作，即事务要么完全操作成功，要么失败后回滚，不再进行部分提交。</p>
<p>对于从 MySQL5.7 复制到 MySQL8 版本中的语句，可以添加 <code>IF EXISTS</code> 或 <code>IF NOT EXISTS</code> 语句来避免发生错误。</p>
<h3 id="18-资源管理">
    <a href="#18-%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.8 资源管理
</h3>
<p>MySQL8 开始支持创建和管理资源组，玩许将服务器内运行的线程分配给特定的分组，以便线程根据组内可用资源执行。组属性能够控制组内资源，启用或限制组内资源消耗。数据库管理员能够根据不同的工作负载适当地更改这些属性。</p>
<p>目前，CPU 时间是可控资源，由 “虚拟CPU” 这个概念来表示，此术语包含 CPU 的核心数，超线程，硬件线程等等。服务器在启动时确定可用的虚拟CPU数量。拥有对应权限的数据库管理员可以将这些CPU 与资源组关联，并为资源组分配线程。</p>
<p>资源组组件为 MySQL 中的资源组管理提供了 SQL 接口。资源组的属性用于定义资源组。MySQL 中存在两个默认组，系统组和用户组，默认的组不能被删除，其属性也不能被更改。对于用户自定义的组，资源组创建时可初始化所有的属性，除去名字和类型，其他属性都可在创建之后进行更改。</p>
<p>在一些平台下，或进行了某些 MySQL 的配置时，资源管理的功能将受到限制，甚至不可用。例如，如果安装了线程池插件，或者使用的是 macOS 系统，资源管理将处于不可用状态。在 FreeBSD 和 Solaris 系统中，资源线程优先级将失效。在 LinuX 系统中，只有配置了 <code>CAP_SYS_NICE</code> 属性，资源管理优先级才能发挥作用。</p>
<h3 id="19-字符集支持">
    <a href="#19-%e5%ad%97%e7%ac%a6%e9%9b%86%e6%94%af%e6%8c%81" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.9 字符集支持
</h3>
<p><img loading="lazy" 
    src="/mysql8-new-features/b600-mysql-8-utf8mb4.en.jpg" 
    alt="b600-mysql-8-utf8mb4.en.jpg" 
     
    width=600 
    height="341"  /></p>
<p>MySQL8 中默认的字符集由 latin1 更改为 <code>utf8mb4</code>，并首次增加了日语所特定使用的集合，
<code>utf8mb4_ja_0900_as_cs</code>。</p>
<h3 id="110-优化器增强">
    <a href="#110-%e4%bc%98%e5%8c%96%e5%99%a8%e5%a2%9e%e5%bc%ba" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.10 优化器增强
</h3>
<p>MySQL 优化器开始支持<code>隐藏索引</code>和<code>降序索引</code>。<code>隐藏索引</code>不会被优化器使用，验证索引的必要性时不需要删除索引，先将索引隐藏，如果优化器性能无影响就可以真正地删除索引。<code>降序索引</code>允许优化器对多个列进行排序，并且允许排序顺序不一致。</p>
<h3 id="111-公用表表达式">
    <a href="#111-%e5%85%ac%e7%94%a8%e8%a1%a8%e8%a1%a8%e8%be%be%e5%bc%8f" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.11 公用表表达式
</h3>
<p>公用表表达式（Common Table Expressions）简称为 CTE，MySQL 现在支持递归和非递归两种形式的 CTE。CTE 通过在 SELECT 语句或其他特定语句前使用 WITH 语句对临时结果集进行命名。
基础语法如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="n">cte_name</span> <span class="p">(</span><span class="n">col_name1</span><span class="p">,</span><span class="n">clo_name2</span><span class="p">..)</span> <span class="k">AS</span> <span class="p">(</span><span class="n">Suquery</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">cte_name</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Subquery 代表子查询,子查询前使用 WITH 语句将结果集命名为 cte_name，在后续的查询中即可使用 cte_name 进行查询。</p>
<h3 id="112-窗口函数">
    <a href="#112-%e7%aa%97%e5%8f%a3%e5%87%bd%e6%95%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.12 窗口函数
</h3>
<p>MySQL8 开始支持窗口函数。在之前的版本中已存在的大部分聚合函数在 MySQL8 中也可以作为窗口函数来使用。</p>
<h3 id="113-正则表达式支持">
    <a href="#113-%e6%ad%a3%e5%88%99%e8%a1%a8%e8%be%be%e5%bc%8f%e6%94%af%e6%8c%81" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    <strong><strong>1.13 正则表达式支持</strong></strong>
</h3>
<p>MySQL 在 8.0.4 以后的版本中采用支持 Unicode 的国际化组件库实现正则表达式操作，这种方式不仅能提供完全的 Unicode 支持，而且是多字节安全编码。</p>
<p>MySQL 增加了 <code>REGEXP_LIKE()</code>、<code>EGEXP_INSTR()</code>、<code>REGEXP_REPLACE()</code> 和 <code>REGEXP_SUBSTRO()</code> 等函数来提升性能。另外，<code>regexp_stack_limit</code> 和 <code>regexp_time_limit</code> 系统变量能够通过匹配引擎来控制资源消耗。</p>
<h3 id="114-内部临时表">
    <a href="#114-%e5%86%85%e9%83%a8%e4%b8%b4%e6%97%b6%e8%a1%a8" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.14 内部临时表
</h3>
<p>empTable 存储引擎取代 MEMORY 存储引擎成为内部临时表的默认存储引擎。TempTable 存储引擎为 <code>VARCHAR</code> 和 <code>VARBINARY</code> 列提供高效存储。</p>
<p><code>internal_tmp_mem_storage_engine</code> 会话变量定义了内部临时表的存储引擎，可选的值有两个，<code>TempTable</code> 和 <code>MEMORY</code> ，其中 TempTable 为默认的存储引擎。<code>temptable_max_ram</code> 系统配置项定义了 TempTable 存储引擎可使用的最大内存数量。</p>
<h3 id="115-日志记录">
    <a href="#115-%e6%97%a5%e5%bf%97%e8%ae%b0%e5%bd%95" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.15 日志记录
</h3>
<p>在 MySQL8 中错误日志子系统由一系列 MySQL 组件构成。这些组件的构成由系统变量 <code>log_error_services</code> 来配置，能够实现日志事件的过滤和写入。</p>
<h3 id="116-备份锁">
    <a href="#116-%e5%a4%87%e4%bb%bd%e9%94%81" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.16 备份锁
</h3>
<p>新的备份锁允许在线备份期间执行数据操作语句，同时阻止可能造成快照不一致的操作。</p>
<p>新备份锁由 <code>LOCK INSTANCE FOR BACKUP</code> 和 <code>UNLOCK INSTANCE</code> 语法提供支持，执行这些操作需要备份管理员特权。</p>
<h3 id="17-增强的-mysql-复制">
    <a href="#17-%e5%a2%9e%e5%bc%ba%e7%9a%84-mysql-%e5%a4%8d%e5%88%b6" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.7 增强的 mysql 复制
</h3>
<p>MySQL8 复制支持对 JSON 文档进行部分更新的二进制日志记录，该记录使用紧凑的二进制格式，从而节省记录完整 JSON 文档的空间。</p>
<p>当使用基于语句的日志记录时，这种紧凑的日志记录会自动完成，并且可以通过将新的 <code>binlog_row_value_options</code> 系统变量值设置为 <code>PARTIAL_JSON</code> 来启用。</p>
<p><img loading="lazy" 
    src="/mysql8-new-features/b600-mysql-database-service5.en.jpg" 
    alt="b600-mysql-database-service5.en.jpg" 
     
    width=600 
    height="343"  /></p>
<h2 id="二窗口函数">
    <a href="#%e4%ba%8c%e7%aa%97%e5%8f%a3%e5%87%bd%e6%95%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    二、窗口函数
</h2>
<h3 id="21-概念">
    <a href="#21-%e6%a6%82%e5%bf%b5" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    2.1 概念
</h3>
<p>MySQL 从 8.0 版本开始支持窗口函数。窗口函数的作用类似于在查询中对数据进行分组，不同的是，分组操作会把分组的结果聚合成一条记录，而窗口函数是将结果置于每一条数据记录中。</p>
<h3 id="22-分类">
    <a href="#22-%e5%88%86%e7%b1%bb" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    2.2 分类
</h3>
<ul>
<li><strong>静态窗口函数</strong>：静态窗口函数的窗口大小是固定的，不会因为记录的不同而不同；</li>
<li><strong>动态窗口函数</strong>：动态窗口函数的窗口大小会随着记录的不同而变化。</li>
</ul>
<h3 id="23-语法结构">
    <a href="#23-%e8%af%ad%e6%b3%95%e7%bb%93%e6%9e%84" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    2.3 语法结构
</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="err">方式一</span>
<span class="err">函数</span> <span class="n">OVER</span> <span class="p">([</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="err">字段名</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="err">字段名</span> <span class="k">ASC</span><span class="o">|</span><span class="k">DESC</span><span class="p">])</span>
<span class="o">#</span><span class="err">方式二</span>
<span class="err">函数</span> <span class="n">OVER</span> <span class="err">窗口名</span> <span class="p">...</span> <span class="n">WINDOW</span> <span class="err">窗口名</span> <span class="k">AS</span> <span class="p">([</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="err">字段名</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="err">字段名</span> <span class="k">ASC</span><span class="o">|</span><span class="k">DESC</span><span class="p">])</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="24-举例">
    <a href="#24-%e4%b8%be%e4%be%8b" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    <strong><strong>2.4 举例</strong></strong>
</h3>
<p><strong>2.4.1 准备表与数据</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">goods</span> <span class="p">(</span>
	<span class="n">id</span> <span class="nb">INT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
	<span class="n">category_id</span> <span class="nb">INT</span><span class="p">,</span>
	<span class="n">category</span> <span class="nb">VARCHAR</span> <span class="p">(</span> <span class="mi">15</span> <span class="p">),</span>
	<span class="n">NAME</span> <span class="nb">VARCHAR</span> <span class="p">(</span> <span class="mi">30</span> <span class="p">),</span>
	<span class="n">price</span> <span class="nb">DECIMAL</span> <span class="p">(</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span> <span class="p">),</span>
	<span class="n">stock</span> <span class="nb">INT</span><span class="p">,</span>
	<span class="n">upper_time</span> <span class="n">DATETIME</span> 
<span class="p">);</span>
	
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">goods</span> <span class="p">(</span> <span class="n">category_id</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">NAME</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">stock</span><span class="p">,</span> <span class="n">upper_time</span> <span class="p">)</span>
<span class="k">VALUES</span>
	<span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;女装/女士精品&#39;</span><span class="p">,</span> <span class="s1">&#39;T恤&#39;</span><span class="p">,</span> <span class="mi">39</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;2020-11-10 00:00:00&#39;</span> <span class="p">),</span>
	<span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;女装/女士精品 &#39;</span><span class="p">,</span> <span class="s1">&#39;连衣裙&#39;</span><span class="p">,</span> <span class="mi">79</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="s1">&#39;2020-11-10 00:00:00&#39;</span> <span class="p">),</span>
	<span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;女装/女士精品&#39;</span><span class="p">,</span> <span class="s1">&#39;卫衣&#39;</span><span class="p">,</span> <span class="mi">89</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="s1">&#39; 2020-11-10 00:00:00 &#39;</span> <span class="p">),</span>
	<span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;女装/女士精品&#39;</span><span class="p">,</span> <span class="s1">&#39;牛仔裤&#39;</span><span class="p">,</span> <span class="mi">89</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">3500</span><span class="p">,</span> <span class="s1">&#39;2020-11-10 00:00:00&#39;</span> <span class="p">),</span>
	<span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;女装/女士精品&#39;</span><span class="p">,</span><span class="s1">&#39;百褶裙&#39;</span><span class="p">,</span><span class="mi">29</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="s1">&#39; 2020-11-10 00:00:00&#39;</span> <span class="p">),</span>
	<span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;女装/女士精品&#39;</span><span class="p">,</span> <span class="s1">&#39;呢绒外套&#39;</span><span class="p">,</span> <span class="mi">399</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="s1">&#39;2020-11-10 00:00:00&#39;</span> <span class="p">),</span>
	<span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;户外运动&#39;</span><span class="p">,</span> <span class="s1">&#39;自行车&#39;</span><span class="p">,</span> <span class="mi">399</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;2020-11-10 00:00:00 &#39;</span> <span class="p">),</span>
	<span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;户外运动&#39;</span><span class="p">,</span> <span class="s1">&#39;山地自行车&#39;</span><span class="p">,</span> <span class="mi">1399</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="s1">&#39;2020-11-10 00:00:00&#39;</span> <span class="p">),</span>
	<span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;户外运动&#39;</span><span class="p">,</span> <span class="s1">&#39;登山杖&#39;</span><span class="p">,</span> <span class="mi">59</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="s1">&#39;2020-11-10 00:00:00&#39;</span> <span class="p">),</span>
	<span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;户外运动&#39;</span><span class="p">,</span> <span class="s1">&#39;骑行装备&#39;</span><span class="p">,</span> <span class="mi">399</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">3500</span><span class="p">,</span> <span class="s1">&#39;2020-11-10 00:00:00&#39;</span> <span class="p">),</span>
	<span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;户外运动&#39;</span><span class="p">,</span> <span class="s1">&#39;运动外套&#39;</span><span class="p">,</span> <span class="mi">799</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39; 2020-11-10 00:00:00 &#39;</span> <span class="p">),</span>
	<span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;户外运动&#39;</span><span class="p">,</span> <span class="s1">&#39;滑板&#39;</span><span class="p">,</span> <span class="mi">499</span><span class="p">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="s1">&#39; 2020-11-10 00:00:00&#39;</span> <span class="p">);</span>	
</code></pre></td></tr></table>
</div>
</div><p><strong>2.4.2 排序函数</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="k">ROW</span> <span class="nb">NUMBER</span><span class="p">()</span><span class="err">函数：按</span><span class="n">PARTITION来给每个区添加顺序排序</span>
<span class="o">#</span><span class="err">举例：查询</span><span class="n">goods数据表中每个商品分类下价格降序排列的各个商品信息</span><span class="err">。</span>
<span class="k">SELECT</span>
	<span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">category_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span> <span class="k">DESC</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">row_num</span><span class="p">,</span>
	<span class="n">id</span><span class="p">,</span>
	<span class="n">category_id</span><span class="p">,</span>
	<span class="n">category</span><span class="p">,</span>
	<span class="n">NAME</span><span class="p">,</span>
	<span class="n">price</span><span class="p">,</span>
	<span class="n">stock</span>
<span class="k">FROM</span>
	<span class="n">goods</span><span class="p">;</span>
	
<span class="o">#</span><span class="err">举例：查询</span><span class="n">goods数据表中每个商品分类下价格最高的3种商品信息</span><span class="err">。</span>
<span class="k">SELECT</span>
	<span class="o">*</span> 
<span class="k">FROM</span>
	<span class="p">(</span>
	<span class="k">SELECT</span>
		<span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">category_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span> <span class="k">DESC</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">row_num</span><span class="p">,</span>
		<span class="n">id</span><span class="p">,</span>
		<span class="n">category_id</span><span class="p">,</span>
		<span class="n">category</span><span class="p">,</span>
		<span class="n">NAME</span><span class="p">,</span>
		<span class="n">price</span><span class="p">,</span>
		<span class="n">stock</span> 
	<span class="k">FROM</span>
		<span class="n">goods</span> 
	<span class="p">)</span> <span class="n">t</span> 
<span class="k">WHERE</span>
	<span class="n">row_num</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span>
	
<span class="o">#</span><span class="n">RANK</span><span class="p">()</span><span class="err">函数：按</span><span class="n">PARTITION来给每个区添加名次排序</span><span class="err">（并列第三就是</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="err">）</span>
<span class="o">#</span><span class="err">举例：使用</span><span class="n">RANK</span><span class="p">()</span><span class="err">函数获取</span><span class="n">goods数据表中各类别的价格从高到低排序的各商品信息</span><span class="err">。</span>
<span class="k">SELECT</span>
	<span class="n">RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">category_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span> <span class="k">DESC</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">row_num</span><span class="p">,</span>
	<span class="n">id</span><span class="p">,</span>
	<span class="n">category_id</span><span class="p">,</span>
	<span class="n">category</span><span class="p">,</span>
	<span class="n">NAME</span><span class="p">,</span>
	<span class="n">price</span><span class="p">,</span>
	<span class="n">stock</span>
<span class="k">FROM</span>
	<span class="n">goods</span><span class="p">;</span>

<span class="o">#</span> <span class="n">DENSE_RANK</span><span class="p">()</span><span class="err">函数：按</span><span class="n">PARTITION来给每个区添加排序</span><span class="err">（并列第三就是</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="err">）</span>
<span class="k">SELECT</span>
	<span class="n">DENSE_RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">category_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span> <span class="k">DESC</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">row_num</span><span class="p">,</span>
	<span class="n">id</span><span class="p">,</span>
	<span class="n">category_id</span><span class="p">,</span>
	<span class="n">category</span><span class="p">,</span>
	<span class="n">NAME</span><span class="p">,</span>
	<span class="n">price</span><span class="p">,</span>
	<span class="n">stock</span> 
<span class="k">FROM</span>
	<span class="n">goods</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>2.4.3 分布函数</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="err">分布函数</span>
<span class="o">#</span><span class="n">PERCENT_RANK</span><span class="p">()</span><span class="err">函数</span><span class="p">:</span><span class="err">公式</span><span class="p">(</span><span class="n">rank</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="k">rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">#</span><span class="err">举例：计算</span><span class="n">goods数据表中名称为</span><span class="err">“女装</span><span class="o">/</span><span class="err">女士精品</span><span class="s2">&#34;的类别下的商品的PERCENT_RANK值。
</span><span class="s2">SELECT
</span><span class="s2">	RANK() OVER ( PARTITION BY category_id ORDER BY price DESC ) AS r,
</span><span class="s2">	PERCENT_RANK() OVER ( PARTITION BY category_id ORDER BY price DESC ) AS pr,
</span><span class="s2">	id,
</span><span class="s2">	category_id,
</span><span class="s2">	category,
</span><span class="s2">	NAME,
</span><span class="s2">	price,
</span><span class="s2">	stock 
</span><span class="s2">FROM
</span><span class="s2">	goods 
</span><span class="s2">WHERE
</span><span class="s2">	category_id = 1;
</span><span class="s2">	
</span><span class="s2">	
</span><span class="s2">#CUME_DIST()函数:当前价格/区的最大价格
</span><span class="s2">#举例：查询goods数据表中小于或等于当前价格的比例。
</span><span class="s2">SELECT
</span><span class="s2">	CUME_DIST() OVER ( PARTITION BY category_id ORDER BY price ASC ) AS cd,
</span><span class="s2">	id,
</span><span class="s2">	category,
</span><span class="s2">	NAME,
</span><span class="s2">	price 
</span><span class="s2">FROM
</span><span class="s2">	goods;
</span></code></pre></td></tr></table>
</div>
</div><p><strong>2.4.4 分布函数</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="n">LAG</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="err">函数：返回当前行的前</span><span class="n">n行的expr值</span>
<span class="o">#</span><span class="err">举例：查询</span><span class="n">goods数据表中前一个商品价格与当前商品价格的差值</span><span class="err">。</span>
<span class="k">SELECT</span>
	<span class="n">id</span><span class="p">,</span>
	<span class="n">category</span><span class="p">,</span>
	<span class="n">NAME</span><span class="p">,</span>
	<span class="n">price</span><span class="p">,</span>
	<span class="n">pre_price</span><span class="p">,</span>
	<span class="n">price</span> <span class="o">-</span> <span class="n">pre_price</span> <span class="k">AS</span> <span class="n">diff_price</span> 
<span class="k">FROM</span>
	<span class="p">(</span>
	<span class="k">SELECT</span>
		<span class="n">id</span><span class="p">,</span>
		<span class="n">category</span><span class="p">,</span>
		<span class="n">NAME</span><span class="p">,</span>
		<span class="n">price</span><span class="p">,</span>
		<span class="n">LAG</span><span class="p">(</span> <span class="n">price</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">category_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span> <span class="k">ASC</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">pre_price</span> 
	<span class="k">FROM</span>
	<span class="n">goods</span> <span class="n">WINDOW</span> <span class="n">w</span> <span class="k">AS</span> <span class="p">(</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">category_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span> <span class="p">))</span> <span class="n">t</span><span class="p">;</span>

<span class="o">#</span><span class="err">其中，子查询是查询当前行数据</span> <span class="o">+</span> <span class="err">上一行价格</span>
<span class="k">SELECT</span>
	<span class="n">id</span><span class="p">,</span>
	<span class="n">category</span><span class="p">,</span>
	<span class="n">NAME</span><span class="p">,</span>
	<span class="n">price</span><span class="p">,</span>
	<span class="n">LAG</span><span class="p">(</span> <span class="n">price</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">category_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span> <span class="k">ASC</span><span class="p">)</span> <span class="k">AS</span> <span class="n">pre_price</span>
<span class="k">FROM</span>
	<span class="n">goods</span>

<span class="o">#</span><span class="n">LEAD</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="err">函数：返回当前行的后</span><span class="n">n行的expr值</span>
<span class="o">#</span><span class="err">举例：查询</span><span class="n">goods数据表中后一个商品价格与当前商品价格的差值</span><span class="err">。</span>
<span class="k">SELECT</span>
	<span class="n">id</span><span class="p">,</span>
	<span class="n">category</span><span class="p">,</span>
	<span class="n">NAME</span><span class="p">,</span>
	<span class="n">price</span><span class="p">,</span>
	<span class="n">behind_price</span><span class="p">,</span>
	<span class="n">price</span> <span class="o">-</span> <span class="n">behind_price</span> <span class="k">AS</span> <span class="n">diff_price</span> 
<span class="k">FROM</span>
	<span class="p">(</span>
	<span class="k">SELECT</span>
		<span class="n">id</span><span class="p">,</span>
		<span class="n">category</span><span class="p">,</span>
		<span class="n">NAME</span><span class="p">,</span>
		<span class="n">price</span><span class="p">,</span>
		<span class="n">LEAD</span><span class="p">(</span> <span class="n">price</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">category_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span> <span class="k">ASC</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">behind_price</span> 
	<span class="k">FROM</span>
	<span class="n">goods</span> <span class="n">WINDOW</span> <span class="n">w</span> <span class="k">AS</span> <span class="p">(</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">category_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span> <span class="p">))</span> <span class="n">t</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>2.4.4 首尾函数</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="n">FIRST_VALUE</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="err">函数</span><span class="p">:</span><span class="err">返回第一个</span><span class="n">expr的值</span>
<span class="o">#</span><span class="err">举例：按照价格排序，查询第</span><span class="mi">1</span><span class="err">个商品的价格信息。</span>
<span class="k">SELECT</span>
	<span class="n">id</span><span class="p">,</span>
	<span class="n">category</span><span class="p">,</span>
	<span class="n">NAME</span><span class="p">,</span>
	<span class="n">price</span><span class="p">,</span>
	<span class="n">stock</span><span class="p">,</span>
	<span class="n">FIRST_VALUE</span><span class="p">(</span> <span class="n">price</span> <span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span> <span class="k">AS</span> <span class="n">first_price</span> 
<span class="k">FROM</span>
	<span class="n">goods</span> <span class="n">WINDOW</span> <span class="n">w</span> <span class="k">AS</span> <span class="p">(</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">category_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span> <span class="p">);</span>
	
<span class="o">#</span><span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="err">函数</span><span class="p">:</span><span class="err">返回最一个</span><span class="n">expr的值</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="25-常用窗口函数">
    <a href="#25-%e5%b8%b8%e7%94%a8%e7%aa%97%e5%8f%a3%e5%87%bd%e6%95%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    <strong><strong>2.5 常用窗口函数</strong></strong>
</h3>
<ul>
<li>排名函数：<code>row_number()</code>、<code>rank()</code>、<code>dense_rank()</code></li>
<li>聚合函数：<code>max()</code>、<code>min()</code>、<code>count()</code>、<code>sum()</code>、<code>avg()</code>、<code>median()</code></li>
<li>向前向后取值：<code>lag()</code>、<code>lead()</code></li>
<li>百分位：<code>percent_rank()</code></li>
<li>取值函数：<code>first_value()</code>、<code>last_value()</code>、<code>nth_value()</code></li>
<li>分箱函数：<code>ntile()</code></li>
</ul>
<h3 id="26-小结">
    <a href="#26-%e5%b0%8f%e7%bb%93" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    2.6 小结
</h3>
<p>窗口函数的特点是可以分组，而且可以在分组内排序。</p>
<p>另外，窗口函数不会因为分组而减少原表中的行数，这对我们在原表数据的基础上进行统计和排序非常有用。</p>
<h2 id="三公用表表达式">
    <a href="#%e4%b8%89%e5%85%ac%e7%94%a8%e8%a1%a8%e8%a1%a8%e8%be%be%e5%bc%8f" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    三、<strong><strong>公用表表达式</strong></strong>
</h2>
<p>公用表表达式（或通用表表达式）简称为 CTE（Common Table Expressions）。</p>
<p>CTE 是一个命名的临时结果集，作用范围是当前语句，CTE 可以理解成一个可以复用的子查询，当然跟子查询还是有点区别的，CTE 可以引用其他 CTE，但子查询不能引用其他子查询。所以，可以考虑代替子查询。</p>
<p>依据语法结构和执行方式的不同，公用表表达式分为<code>普通公用表表达式</code>和<code>递归公用表表达式</code>两种。</p>
<h3 id="31-普通共用表达式">
    <a href="#31-%e6%99%ae%e9%80%9a%e5%85%b1%e7%94%a8%e8%a1%a8%e8%be%be%e5%bc%8f" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    3.1 普通共用表达式
</h3>
<p><strong>3.1.1 语法</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="n">CTE名称</span>
<span class="k">AS</span> <span class="p">(</span><span class="err">子查询</span><span class="p">)</span>
<span class="k">SELECT</span><span class="o">|</span><span class="k">DELETE</span><span class="o">|</span><span class="k">UPDATE</span> <span class="err">语句</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>3.1.2 举例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="err">子查询语句</span>
<span class="k">SELECT</span>
	<span class="o">*</span> 
<span class="k">FROM</span>
	<span class="n">departments</span> 
<span class="k">WHERE</span>
	<span class="n">department_id</span> <span class="k">IN</span> <span class="p">(</span> <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">department_id</span> <span class="k">FROM</span> <span class="n">employees</span> <span class="p">);</span>
	
<span class="o">#</span><span class="err">普通公用表达式</span>
<span class="k">WITH</span> <span class="n">department_id_socpe</span> <span class="k">AS</span> <span class="p">(</span> <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">department_id</span> <span class="k">FROM</span> <span class="n">employees</span> <span class="p">)</span>
<span class="k">SELECT</span>
<span class="o">*</span> 
<span class="k">FROM</span>
	<span class="n">departments</span> <span class="n">d</span>
	<span class="k">JOIN</span> <span class="n">department_id_socpe</span> <span class="n">d_s</span> 
<span class="k">WHERE</span>
	<span class="n">d</span><span class="p">.</span><span class="n">department_id</span> <span class="o">=</span> <span class="n">d_s</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="32-递归公用表达式">
    <a href="#32-%e9%80%92%e5%bd%92%e5%85%ac%e7%94%a8%e8%a1%a8%e8%be%be%e5%bc%8f" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    3.2 递归公用表达式
</h3>
<p><strong>3.2.1 语法</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span>
<span class="n">CTE名称</span> <span class="k">AS</span> <span class="p">(</span><span class="err">子查询</span><span class="p">)</span>
<span class="k">SELECT</span><span class="o">|</span><span class="k">DELETE</span><span class="o">|</span><span class="k">UPDATE</span> <span class="err">语句</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>3.2.2 举例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="err">递归公用表达式</span>
<span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">cte</span> <span class="k">AS</span> <span class="p">(</span>
	<span class="k">SELECT</span>
		<span class="n">employee_id</span><span class="p">,</span>
		<span class="n">last_name</span><span class="p">,</span>
		<span class="n">manager_id</span><span class="p">,</span>
		<span class="mi">1</span> <span class="k">AS</span> <span class="n">n</span> 
	<span class="k">FROM</span>
		<span class="n">employees</span> 
	<span class="k">WHERE</span>
		<span class="n">employee_id</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1">-- 种子查询，找到他的下下属
</span><span class="c1"></span>	<span class="k">UNION</span> <span class="k">ALL</span>
	<span class="k">SELECT</span>
		<span class="n">a</span><span class="p">.</span><span class="n">employee_id</span><span class="p">,</span>
		<span class="n">a</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span>
		<span class="n">a</span><span class="p">.</span><span class="n">manager_id</span><span class="p">,</span>
		<span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> 
	<span class="k">FROM</span>
		<span class="n">employees</span> <span class="k">AS</span> <span class="n">a</span>
		<span class="k">JOIN</span> <span class="n">cte</span> <span class="k">ON</span> <span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">manager_id</span> <span class="o">=</span> <span class="n">cte</span><span class="p">.</span><span class="n">employee_id</span> <span class="p">)</span> <span class="c1">-- 递归查询，找出以递归公用表达式的人为领导的人
</span><span class="c1"></span>	<span class="p">)</span> 
<span class="k">SELECT</span>
	<span class="n">employee_id</span><span class="p">,</span>
	<span class="n">last_name</span> 
<span class="k">FROM</span>
	<span class="n">cte</span> 
<span class="k">WHERE</span>
	<span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>3.2.3 小结</strong></p>
<p>公用表表达式的作用是可以替代子查询，而且可以被多次引用。递归公用表表达式对查询有一个共同根节点的树形结构数据非常高效，可以轻松搞定其他查询方式难以处理的查询。</p>
<p>————————————————</p>
<p>版权声明：本文为CSDN博主「不入开发不工作」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。</p>
<p>原文链接：https://blog.csdn.net/weixin_46245201/article/details/123002895</p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/post/aria2/aria2-chinese-manual-1/" title="aria2 中文手册（一）-详细介绍、编译、交叉编译">
            <span>上一篇</span>
            aria2 中文手册（一）-详细介绍、编译、交叉编译
        </a>
        

        
        <a rel="next" href="/post/mysql/mysql8-windows-install/" title="MySQL8 的 Windows 安装详细流程">
            <span>下一篇</span>
            MySQL8 的 Windows 安装详细流程
        </a>
        
    </nav>
    
</div>

<div class="container">
    
</div>

</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
            <a href="https://beian.miit.gov.cn/">冀ICP备20017556号-1</a>
            
        </nav>

        
    </section>
    <script defer src="/ts/features.c81551cd4dbef120af278f16966a41142c02be9ff5d6a669be09820fbf047456.js" 
    data-enable-footnotes="true"
    ></script>
</footer>

    </body>
</html>