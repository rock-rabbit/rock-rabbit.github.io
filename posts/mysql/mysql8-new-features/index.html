<!doctype html>
<html lang="zh-cn">
  <head>
    <title>MySQL8 的新特性：NoSQL、索引、账户管理、窗口函数... // rock rabbit</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.81.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="rock rabbit" />
    <meta name="description" content="MySQL8 是 Oracle 公司推出的新款 MySQL Server 版本，有着相比 MYSQL5.7 版本更好的性能以及许多新特性。" />
    <link rel="stylesheet" href="/css/main.min.3c3c186cd62e563ad6e2f00a89dbee656ab912d1d46f856b5605dd0232521e2a.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MySQL8 的新特性：NoSQL、索引、账户管理、窗口函数..."/>
<meta name="twitter:description" content="MySQL8 是 Oracle 公司推出的新款 MySQL Server 版本，有着相比 MYSQL5.7 版本更好的性能以及许多新特性。"/>

    <meta property="og:title" content="MySQL8 的新特性：NoSQL、索引、账户管理、窗口函数..." />
<meta property="og:description" content="MySQL8 是 Oracle 公司推出的新款 MySQL Server 版本，有着相比 MYSQL5.7 版本更好的性能以及许多新特性。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://rock-rabbit.github.io/posts/mysql/mysql8-new-features/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-05T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2022-07-05T00:00:00&#43;00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="http://rock-rabbit.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="rock rabbit" /></a>
      <span class="app-header-title">rock rabbit</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
             - 
          
          <a class="app-header-menu-item" href="/about/">About</a>
      </nav>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
      <div class="app-header-social">
        
          <a href="https://github.com/rock-rabbit" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>rock-rabbit</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">MySQL8 的新特性：NoSQL、索引、账户管理、窗口函数...</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jul 5, 2022
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          5 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="http://rock-rabbit.github.io/tags/mysql/">Mysql</a>
              <a class="tag" href="http://rock-rabbit.github.io/tags/%E5%BF%AB%E6%8D%B7%E6%89%8B%E5%86%8C/">快捷手册</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <h2 id="一新特性概述">一、新特性概述</h2>
<h3 id="11-更简便的-nosql-支持">1.1 更简便的 NoSQL 支持</h3>
<p><img src="mysql8-new-features/b600-mysql-8-mds.en.jpg" alt="b600-mysql-8-mds.en.jpg"></p>
<p><code>NoSQL</code> 泛指非关系型数据库和数据存储。随着互联网平台的规模飞速发展，传统的关系型数据库已经越来越不能满足需求。</p>
<p>从 5.6 版本开始，MySQL 就开始支持简单的 NoSQL 存储功能。MySQL8 对这一功能做了优化，以更灵活的方式实现 <code>NosQL</code> 功能，不再依赖模式（schema）。</p>
<h3 id="12-更好的索引">1.2 更好的索引</h3>
<p><img src="mysql8-new-features/b600-mysql-8-2x.en.jpg" alt="b600-mysql-8-2x.en.jpg"></p>
<p>在查询中，正确地使用索引可以提高查询的效率，MySQL8 中新增了<code>隐藏索引</code>和<code>降序索引</code>，隐藏索引可以用来测试去掉索引对查询性能的影响。在查询中混合存在多列索引时，使用降序索引可以提高查询的性能。</p>
<h3 id="13-更完善的-json-支持">1.3 更完善的 JSON 支持</h3>
<p>MySQL 从 5.7 开始支持原生 JSON 数据的存储，MySQL8 对这一功能做了优化，增加了聚合函数<code>JSON_ARRAYAGG()</code> 和 <code>JSON_OBJECTAGG()</code>，将参数聚合为 JSON 数组或对象，新增了行内操作符 <code>-&gt;&gt;</code> ，是列路径运算符 <code>-&gt;</code> 的增强，对 JSON 排序做了提升，并优化了 JSON 的更新操作。</p>
<h3 id="14-安全和账户管理">1.4 安全和账户管理</h3>
<p>MySQL8 中新增了 <code>caching_sha2_password</code> 授权插件、角色、密码历史记录和 FIPS 模式支持，这些特性提高了数据库的安全性和性能，使数据库管理员能够更灵活地进行账户管理工作。</p>
<h3 id="15-innodb-的变化">1.5 InnoDB 的变化</h3>
<p>InnoDB 是 MySQL 默认的存储引擎，是事务型数据库的首选引擎，支持事务安全表（ACID），支持行锁定和外键。在 MySQL8 版本中，InnoDB 在自增、索引、加密、死锁、共享锁等方面做了大量的改进和优化，并且支持原子数据定义语言（DDL），提高了数据安全性，对事务提供更好的支持。</p>
<h3 id="16-数据字典">1.6 数据字典</h3>
<p>在之前的 MySQL 版本中，字典数据都存储在元数据文件和非事务表中。从 MySQL8 开始新增了事务数据字典，在这个字典里存储着数据库对象信息，这些数据字典存储在内部事务表中。</p>
<h3 id="17-原子数据定义语句">1.7 原子数据定义语句</h3>
<p>MySQL8 开始支持原子数据定义语句（Automic DDL），即原子 DDL。目前，只有 InnoDB 存储引擎支持原子 DDL。原子数据定义语句（DDL）将与 DDL 操作相关的数据字典更新、存储引擎操作、二进制日志写入结合到一个单独的原子事务中，这使得即使服务器崩溃，事务也会提交或回滚。</p>
<p>使用支持原子操作的存储引擎所创建的表，在执行 <code>DROP TABLE</code>、<code>CREATE TABLE</code>、<code>ALTER TABLE</code>、<code>RENAME TABLE</code>、<code>TRUNCATE TABLE</code>、<code>CREATE TABLESPACE</code>、<code>DROP TABLESPACE</code> 等操作时，都支持原子操作，即事务要么完全操作成功，要么失败后回滚，不再进行部分提交。</p>
<p>对于从 MySQL5.7 复制到 MySQL8 版本中的语句，可以添加 <code>IF EXISTS</code> 或 <code>IF NOT EXISTS</code> 语句来避免发生错误。</p>
<h3 id="18-资源管理">1.8 资源管理</h3>
<p>MySQL8 开始支持创建和管理资源组，玩许将服务器内运行的线程分配给特定的分组，以便线程根据组内可用资源执行。组属性能够控制组内资源，启用或限制组内资源消耗。数据库管理员能够根据不同的工作负载适当地更改这些属性。</p>
<p>目前，CPU 时间是可控资源，由 “虚拟CPU” 这个概念来表示，此术语包含 CPU 的核心数，超线程，硬件线程等等。服务器在启动时确定可用的虚拟CPU数量。拥有对应权限的数据库管理员可以将这些CPU 与资源组关联，并为资源组分配线程。</p>
<p>资源组组件为 MySQL 中的资源组管理提供了 SQL 接口。资源组的属性用于定义资源组。MySQL 中存在两个默认组，系统组和用户组，默认的组不能被删除，其属性也不能被更改。对于用户自定义的组，资源组创建时可初始化所有的属性，除去名字和类型，其他属性都可在创建之后进行更改。</p>
<p>在一些平台下，或进行了某些 MySQL 的配置时，资源管理的功能将受到限制，甚至不可用。例如，如果安装了线程池插件，或者使用的是 macOS 系统，资源管理将处于不可用状态。在 FreeBSD 和 Solaris 系统中，资源线程优先级将失效。在 LinuX 系统中，只有配置了 <code>CAP_SYS_NICE</code> 属性，资源管理优先级才能发挥作用。</p>
<h3 id="19-字符集支持">1.9 字符集支持</h3>
<p><img src="mysql8-new-features/b600-mysql-8-utf8mb4.en.jpg" alt="b600-mysql-8-utf8mb4.en.jpg"></p>
<p>MySQL8 中默认的字符集由 latin1 更改为 <code>utf8mb4</code>，并首次增加了日语所特定使用的集合，
<code>utf8mb4_ja_0900_as_cs</code>。</p>
<h3 id="110-优化器增强">1.10 优化器增强</h3>
<p>MySQL 优化器开始支持<code>隐藏索引</code>和<code>降序索引</code>。<code>隐藏索引</code>不会被优化器使用，验证索引的必要性时不需要删除索引，先将索引隐藏，如果优化器性能无影响就可以真正地删除索引。<code>降序索引</code>允许优化器对多个列进行排序，并且允许排序顺序不一致。</p>
<h3 id="111-公用表表达式">1.11 公用表表达式</h3>
<p>公用表表达式（Common Table Expressions）简称为 CTE，MySQL 现在支持递归和非递归两种形式的 CTE。CTE 通过在 SELECT 语句或其他特定语句前使用 WITH 语句对临时结果集进行命名。
基础语法如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">WITH</span> cte_name (col_name1,clo_name2..) <span style="color:#66d9ef">AS</span> (Suquery)
<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> cte_name;
</code></pre></div><p>Subquery 代表子查询,子查询前使用 WITH 语句将结果集命名为 cte_name，在后续的查询中即可使用 cte_name 进行查询。</p>
<h3 id="112-窗口函数">1.12 窗口函数</h3>
<p>MySQL8 开始支持窗口函数。在之前的版本中已存在的大部分聚合函数在 MySQL8 中也可以作为窗口函数来使用。</p>
<h3 id="113-正则表达式支持"><strong><strong>1.13 正则表达式支持</strong></strong></h3>
<p>MySQL 在 8.0.4 以后的版本中采用支持 Unicode 的国际化组件库实现正则表达式操作，这种方式不仅能提供完全的 Unicode 支持，而且是多字节安全编码。</p>
<p>MySQL 增加了 <code>REGEXP_LIKE()</code>、<code>EGEXP_INSTR()</code>、<code>REGEXP_REPLACE()</code> 和 <code>REGEXP_SUBSTRO()</code> 等函数来提升性能。另外，<code>regexp_stack_limit</code> 和 <code>regexp_time_limit</code> 系统变量能够通过匹配引擎来控制资源消耗。</p>
<h3 id="114-内部临时表">1.14 内部临时表</h3>
<p>empTable 存储引擎取代 MEMORY 存储引擎成为内部临时表的默认存储引擎。TempTable 存储引擎为 <code>VARCHAR</code> 和 <code>VARBINARY</code> 列提供高效存储。</p>
<p><code>internal_tmp_mem_storage_engine</code> 会话变量定义了内部临时表的存储引擎，可选的值有两个，<code>TempTable</code> 和 <code>MEMORY</code> ，其中 TempTable 为默认的存储引擎。<code>temptable_max_ram</code> 系统配置项定义了 TempTable 存储引擎可使用的最大内存数量。</p>
<h3 id="115-日志记录">1.15 日志记录</h3>
<p>在 MySQL8 中错误日志子系统由一系列 MySQL 组件构成。这些组件的构成由系统变量 <code>log_error_services</code> 来配置，能够实现日志事件的过滤和写入。</p>
<h3 id="116-备份锁">1.16 备份锁</h3>
<p>新的备份锁允许在线备份期间执行数据操作语句，同时阻止可能造成快照不一致的操作。</p>
<p>新备份锁由 <code>LOCK INSTANCE FOR BACKUP</code> 和 <code>UNLOCK INSTANCE</code> 语法提供支持，执行这些操作需要备份管理员特权。</p>
<h3 id="17-增强的-mysql-复制">1.7 增强的 mysql 复制</h3>
<p>MySQL8 复制支持对 JSON 文档进行部分更新的二进制日志记录，该记录使用紧凑的二进制格式，从而节省记录完整 JSON 文档的空间。</p>
<p>当使用基于语句的日志记录时，这种紧凑的日志记录会自动完成，并且可以通过将新的 <code>binlog_row_value_options</code> 系统变量值设置为 <code>PARTIAL_JSON</code> 来启用。</p>
<p><img src="mysql8-new-features/b600-mysql-database-service5.en.jpg" alt="b600-mysql-database-service5.en.jpg"></p>
<h2 id="二窗口函数">二、窗口函数</h2>
<h3 id="21-概念">2.1 概念</h3>
<p>MySQL 从 8.0 版本开始支持窗口函数。窗口函数的作用类似于在查询中对数据进行分组，不同的是，分组操作会把分组的结果聚合成一条记录，而窗口函数是将结果置于每一条数据记录中。</p>
<h3 id="22-分类">2.2 分类</h3>
<ul>
<li><strong>静态窗口函数</strong>：静态窗口函数的窗口大小是固定的，不会因为记录的不同而不同；</li>
<li><strong>动态窗口函数</strong>：动态窗口函数的窗口大小会随着记录的不同而变化。</li>
</ul>
<h3 id="23-语法结构">2.3 语法结构</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">方式一</span>
<span style="color:#960050;background-color:#1e0010">函数</span> OVER ([PARTITION <span style="color:#66d9ef">BY</span> <span style="color:#960050;background-color:#1e0010">字段名</span> <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#960050;background-color:#1e0010">字段名</span> <span style="color:#66d9ef">ASC</span><span style="color:#f92672">|</span><span style="color:#66d9ef">DESC</span>])
<span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">方式二</span>
<span style="color:#960050;background-color:#1e0010">函数</span> OVER <span style="color:#960050;background-color:#1e0010">窗口名</span> ... WINDOW <span style="color:#960050;background-color:#1e0010">窗口名</span> <span style="color:#66d9ef">AS</span> ([PARTITION <span style="color:#66d9ef">BY</span> <span style="color:#960050;background-color:#1e0010">字段名</span> <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#960050;background-color:#1e0010">字段名</span> <span style="color:#66d9ef">ASC</span><span style="color:#f92672">|</span><span style="color:#66d9ef">DESC</span>])
</code></pre></div><h3 id="24-举例"><strong><strong>2.4 举例</strong></strong></h3>
<p><strong>2.4.1 准备表与数据</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> goods (
	id INT <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> AUTO_INCREMENT,
	category_id INT,
	category VARCHAR ( <span style="color:#ae81ff">15</span> ),
	NAME VARCHAR ( <span style="color:#ae81ff">30</span> ),
	price DECIMAL ( <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">2</span> ),
	stock INT,
	upper_time DATETIME 
);
	
<span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> goods ( category_id, category, NAME, price, stock, upper_time )
<span style="color:#66d9ef">VALUES</span>
	( <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;女装/女士精品&#39;</span>, <span style="color:#e6db74">&#39;T恤&#39;</span>, <span style="color:#ae81ff">39</span>.<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">1000</span>, <span style="color:#e6db74">&#39;2020-11-10 00:00:00&#39;</span> ),
	( <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;女装/女士精品 &#39;</span>, <span style="color:#e6db74">&#39;连衣裙&#39;</span>, <span style="color:#ae81ff">79</span>.<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">2500</span>, <span style="color:#e6db74">&#39;2020-11-10 00:00:00&#39;</span> ),
	( <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;女装/女士精品&#39;</span>, <span style="color:#e6db74">&#39;卫衣&#39;</span>, <span style="color:#ae81ff">89</span>.<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">1500</span>, <span style="color:#e6db74">&#39; 2020-11-10 00:00:00 &#39;</span> ),
	( <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;女装/女士精品&#39;</span>, <span style="color:#e6db74">&#39;牛仔裤&#39;</span>, <span style="color:#ae81ff">89</span>.<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">3500</span>, <span style="color:#e6db74">&#39;2020-11-10 00:00:00&#39;</span> ),
	( <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;女装/女士精品&#39;</span>,<span style="color:#e6db74">&#39;百褶裙&#39;</span>,<span style="color:#ae81ff">29</span>.<span style="color:#ae81ff">90</span>,<span style="color:#ae81ff">500</span>,<span style="color:#e6db74">&#39; 2020-11-10 00:00:00&#39;</span> ),
	( <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;女装/女士精品&#39;</span>, <span style="color:#e6db74">&#39;呢绒外套&#39;</span>, <span style="color:#ae81ff">399</span>.<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">1200</span>, <span style="color:#e6db74">&#39;2020-11-10 00:00:00&#39;</span> ),
	( <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;户外运动&#39;</span>, <span style="color:#e6db74">&#39;自行车&#39;</span>, <span style="color:#ae81ff">399</span>.<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">1000</span>, <span style="color:#e6db74">&#39;2020-11-10 00:00:00 &#39;</span> ),
	( <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;户外运动&#39;</span>, <span style="color:#e6db74">&#39;山地自行车&#39;</span>, <span style="color:#ae81ff">1399</span>.<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">2500</span>, <span style="color:#e6db74">&#39;2020-11-10 00:00:00&#39;</span> ),
	( <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;户外运动&#39;</span>, <span style="color:#e6db74">&#39;登山杖&#39;</span>, <span style="color:#ae81ff">59</span>.<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">1500</span>, <span style="color:#e6db74">&#39;2020-11-10 00:00:00&#39;</span> ),
	( <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;户外运动&#39;</span>, <span style="color:#e6db74">&#39;骑行装备&#39;</span>, <span style="color:#ae81ff">399</span>.<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">3500</span>, <span style="color:#e6db74">&#39;2020-11-10 00:00:00&#39;</span> ),
	( <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;户外运动&#39;</span>, <span style="color:#e6db74">&#39;运动外套&#39;</span>, <span style="color:#ae81ff">799</span>.<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">500</span>, <span style="color:#e6db74">&#39; 2020-11-10 00:00:00 &#39;</span> ),
	( <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;户外运动&#39;</span>, <span style="color:#e6db74">&#39;滑板&#39;</span>, <span style="color:#ae81ff">499</span>.<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">1200</span>, <span style="color:#e6db74">&#39; 2020-11-10 00:00:00&#39;</span> );	
</code></pre></div><p><strong>2.4.2 排序函数</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span><span style="color:#66d9ef">ROW</span> NUMBER()<span style="color:#960050;background-color:#1e0010">函数：按</span>PARTITION来给每个区添加顺序排序
<span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">举例：查询</span>goods数据表中每个商品分类下价格降序排列的各个商品信息<span style="color:#960050;background-color:#1e0010">。</span>
<span style="color:#66d9ef">SELECT</span>
	ROW_NUMBER() OVER ( PARTITION <span style="color:#66d9ef">BY</span> category_id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> price <span style="color:#66d9ef">DESC</span> ) <span style="color:#66d9ef">AS</span> row_num,
	id,
	category_id,
	category,
	NAME,
	price,
	stock
<span style="color:#66d9ef">FROM</span>
	goods;
	
<span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">举例：查询</span>goods数据表中每个商品分类下价格最高的3种商品信息<span style="color:#960050;background-color:#1e0010">。</span>
<span style="color:#66d9ef">SELECT</span>
	<span style="color:#f92672">*</span> 
<span style="color:#66d9ef">FROM</span>
	(
	<span style="color:#66d9ef">SELECT</span>
		ROW_NUMBER() OVER ( PARTITION <span style="color:#66d9ef">BY</span> category_id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> price <span style="color:#66d9ef">DESC</span> ) <span style="color:#66d9ef">AS</span> row_num,
		id,
		category_id,
		category,
		NAME,
		price,
		stock 
	<span style="color:#66d9ef">FROM</span>
		goods 
	) t 
<span style="color:#66d9ef">WHERE</span>
	row_num <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span>;
	
<span style="color:#f92672">#</span>RANK()<span style="color:#960050;background-color:#1e0010">函数：按</span>PARTITION来给每个区添加名次排序<span style="color:#960050;background-color:#1e0010">（并列第三就是</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">5</span><span style="color:#960050;background-color:#1e0010">）</span>
<span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">举例：使用</span>RANK()<span style="color:#960050;background-color:#1e0010">函数获取</span>goods数据表中各类别的价格从高到低排序的各商品信息<span style="color:#960050;background-color:#1e0010">。</span>
<span style="color:#66d9ef">SELECT</span>
	RANK() OVER ( PARTITION <span style="color:#66d9ef">BY</span> category_id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> price <span style="color:#66d9ef">DESC</span> ) <span style="color:#66d9ef">AS</span> row_num,
	id,
	category_id,
	category,
	NAME,
	price,
	stock
<span style="color:#66d9ef">FROM</span>
	goods;

<span style="color:#f92672">#</span> DENSE_RANK()<span style="color:#960050;background-color:#1e0010">函数：按</span>PARTITION来给每个区添加排序<span style="color:#960050;background-color:#1e0010">（并列第三就是</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span><span style="color:#960050;background-color:#1e0010">）</span>
<span style="color:#66d9ef">SELECT</span>
	DENSE_RANK() OVER ( PARTITION <span style="color:#66d9ef">BY</span> category_id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> price <span style="color:#66d9ef">DESC</span> ) <span style="color:#66d9ef">AS</span> row_num,
	id,
	category_id,
	category,
	NAME,
	price,
	stock 
<span style="color:#66d9ef">FROM</span>
	goods;
</code></pre></div><p><strong>2.4.3 分布函数</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">分布函数</span>
<span style="color:#f92672">#</span>PERCENT_RANK()<span style="color:#960050;background-color:#1e0010">函数</span>:<span style="color:#960050;background-color:#1e0010">公式</span>(rank <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>(<span style="color:#66d9ef">rows</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
<span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">举例：计算</span>goods数据表中名称为<span style="color:#960050;background-color:#1e0010">“女装</span><span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010">女士精品</span><span style="color:#e6db74">&#34;的类别下的商品的PERCENT_RANK值。
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">	RANK() OVER ( PARTITION BY category_id ORDER BY price DESC ) AS r,
</span><span style="color:#e6db74">	PERCENT_RANK() OVER ( PARTITION BY category_id ORDER BY price DESC ) AS pr,
</span><span style="color:#e6db74">	id,
</span><span style="color:#e6db74">	category_id,
</span><span style="color:#e6db74">	category,
</span><span style="color:#e6db74">	NAME,
</span><span style="color:#e6db74">	price,
</span><span style="color:#e6db74">	stock 
</span><span style="color:#e6db74">FROM
</span><span style="color:#e6db74">	goods 
</span><span style="color:#e6db74">WHERE
</span><span style="color:#e6db74">	category_id = 1;
</span><span style="color:#e6db74">	
</span><span style="color:#e6db74">	
</span><span style="color:#e6db74">#CUME_DIST()函数:当前价格/区的最大价格
</span><span style="color:#e6db74">#举例：查询goods数据表中小于或等于当前价格的比例。
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">	CUME_DIST() OVER ( PARTITION BY category_id ORDER BY price ASC ) AS cd,
</span><span style="color:#e6db74">	id,
</span><span style="color:#e6db74">	category,
</span><span style="color:#e6db74">	NAME,
</span><span style="color:#e6db74">	price 
</span><span style="color:#e6db74">FROM
</span><span style="color:#e6db74">	goods;
</span></code></pre></div><p><strong>2.4.4 分布函数</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span>LAG(expr,n)<span style="color:#960050;background-color:#1e0010">函数：返回当前行的前</span>n行的expr值
<span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">举例：查询</span>goods数据表中前一个商品价格与当前商品价格的差值<span style="color:#960050;background-color:#1e0010">。</span>
<span style="color:#66d9ef">SELECT</span>
	id,
	category,
	NAME,
	price,
	pre_price,
	price <span style="color:#f92672">-</span> pre_price <span style="color:#66d9ef">AS</span> diff_price 
<span style="color:#66d9ef">FROM</span>
	(
	<span style="color:#66d9ef">SELECT</span>
		id,
		category,
		NAME,
		price,
		LAG( price, <span style="color:#ae81ff">1</span> ) OVER ( PARTITION <span style="color:#66d9ef">BY</span> category_id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> price <span style="color:#66d9ef">ASC</span> ) <span style="color:#66d9ef">AS</span> pre_price 
	<span style="color:#66d9ef">FROM</span>
	goods WINDOW w <span style="color:#66d9ef">AS</span> ( PARTITION <span style="color:#66d9ef">BY</span> category_id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> price )) t;

<span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">其中，子查询是查询当前行数据</span> <span style="color:#f92672">+</span> <span style="color:#960050;background-color:#1e0010">上一行价格</span>
<span style="color:#66d9ef">SELECT</span>
	id,
	category,
	NAME,
	price,
	LAG( price, <span style="color:#ae81ff">1</span> ) OVER ( PARTITION <span style="color:#66d9ef">BY</span> category_id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> price <span style="color:#66d9ef">ASC</span>) <span style="color:#66d9ef">AS</span> pre_price
<span style="color:#66d9ef">FROM</span>
	goods

<span style="color:#f92672">#</span>LEAD(expr,n)<span style="color:#960050;background-color:#1e0010">函数：返回当前行的后</span>n行的expr值
<span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">举例：查询</span>goods数据表中后一个商品价格与当前商品价格的差值<span style="color:#960050;background-color:#1e0010">。</span>
<span style="color:#66d9ef">SELECT</span>
	id,
	category,
	NAME,
	price,
	behind_price,
	price <span style="color:#f92672">-</span> behind_price <span style="color:#66d9ef">AS</span> diff_price 
<span style="color:#66d9ef">FROM</span>
	(
	<span style="color:#66d9ef">SELECT</span>
		id,
		category,
		NAME,
		price,
		LEAD( price, <span style="color:#ae81ff">1</span> ) OVER ( PARTITION <span style="color:#66d9ef">BY</span> category_id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> price <span style="color:#66d9ef">ASC</span> ) <span style="color:#66d9ef">AS</span> behind_price 
	<span style="color:#66d9ef">FROM</span>
	goods WINDOW w <span style="color:#66d9ef">AS</span> ( PARTITION <span style="color:#66d9ef">BY</span> category_id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> price )) t;
</code></pre></div><p><strong>2.4.4 首尾函数</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span>FIRST_VALUE(expr)<span style="color:#960050;background-color:#1e0010">函数</span>:<span style="color:#960050;background-color:#1e0010">返回第一个</span>expr的值
<span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">举例：按照价格排序，查询第</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">个商品的价格信息。</span>
<span style="color:#66d9ef">SELECT</span>
	id,
	category,
	NAME,
	price,
	stock,
	FIRST_VALUE( price ) OVER w <span style="color:#66d9ef">AS</span> first_price 
<span style="color:#66d9ef">FROM</span>
	goods WINDOW w <span style="color:#66d9ef">AS</span> ( PARTITION <span style="color:#66d9ef">BY</span> category_id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> price );
	
<span style="color:#f92672">#</span>LAST_VALUE(expr)<span style="color:#960050;background-color:#1e0010">函数</span>:<span style="color:#960050;background-color:#1e0010">返回最一个</span>expr的值
</code></pre></div><h3 id="25-常用窗口函数"><strong><strong>2.5 常用窗口函数</strong></strong></h3>
<ul>
<li>排名函数：<code>row_number()</code>、<code>rank()</code>、<code>dense_rank()</code></li>
<li>聚合函数：<code>max()</code>、<code>min()</code>、<code>count()</code>、<code>sum()</code>、<code>avg()</code>、<code>median()</code></li>
<li>向前向后取值：<code>lag()</code>、<code>lead()</code></li>
<li>百分位：<code>percent_rank()</code></li>
<li>取值函数：<code>first_value()</code>、<code>last_value()</code>、<code>nth_value()</code></li>
<li>分箱函数：<code>ntile()</code></li>
</ul>
<h3 id="26-小结">2.6 小结</h3>
<p>窗口函数的特点是可以分组，而且可以在分组内排序。</p>
<p>另外，窗口函数不会因为分组而减少原表中的行数，这对我们在原表数据的基础上进行统计和排序非常有用。</p>
<h2 id="三公用表表达式">三、<strong><strong>公用表表达式</strong></strong></h2>
<p>公用表表达式（或通用表表达式）简称为 CTE（Common Table Expressions）。</p>
<p>CTE 是一个命名的临时结果集，作用范围是当前语句，CTE 可以理解成一个可以复用的子查询，当然跟子查询还是有点区别的，CTE 可以引用其他 CTE，但子查询不能引用其他子查询。所以，可以考虑代替子查询。</p>
<p>依据语法结构和执行方式的不同，公用表表达式分为<code>普通公用表表达式</code>和<code>递归公用表表达式</code>两种。</p>
<h3 id="31-普通共用表达式">3.1 普通共用表达式</h3>
<p><strong>3.1.1 语法</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">WITH</span> CTE名称
<span style="color:#66d9ef">AS</span> (<span style="color:#960050;background-color:#1e0010">子查询</span>)
<span style="color:#66d9ef">SELECT</span><span style="color:#f92672">|</span><span style="color:#66d9ef">DELETE</span><span style="color:#f92672">|</span><span style="color:#66d9ef">UPDATE</span> <span style="color:#960050;background-color:#1e0010">语句</span>
</code></pre></div><p><strong>3.1.2 举例</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">子查询语句</span>
<span style="color:#66d9ef">SELECT</span>
	<span style="color:#f92672">*</span> 
<span style="color:#66d9ef">FROM</span>
	departments 
<span style="color:#66d9ef">WHERE</span>
	department_id <span style="color:#66d9ef">IN</span> ( <span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">DISTINCT</span> department_id <span style="color:#66d9ef">FROM</span> employees );
	
<span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">普通公用表达式</span>
<span style="color:#66d9ef">WITH</span> department_id_socpe <span style="color:#66d9ef">AS</span> ( <span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">DISTINCT</span> department_id <span style="color:#66d9ef">FROM</span> employees )
<span style="color:#66d9ef">SELECT</span>
<span style="color:#f92672">*</span> 
<span style="color:#66d9ef">FROM</span>
	departments d
	<span style="color:#66d9ef">JOIN</span> department_id_socpe d_s 
<span style="color:#66d9ef">WHERE</span>
	d.department_id <span style="color:#f92672">=</span> d_s.department_id;
</code></pre></div><h3 id="32-递归公用表达式">3.2 递归公用表达式</h3>
<p><strong>3.2.1 语法</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">RECURSIVE</span>
CTE名称 <span style="color:#66d9ef">AS</span> (<span style="color:#960050;background-color:#1e0010">子查询</span>)
<span style="color:#66d9ef">SELECT</span><span style="color:#f92672">|</span><span style="color:#66d9ef">DELETE</span><span style="color:#f92672">|</span><span style="color:#66d9ef">UPDATE</span> <span style="color:#960050;background-color:#1e0010">语句</span>
</code></pre></div><p><strong>3.2.2 举例</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">递归公用表达式</span>
<span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">RECURSIVE</span> cte <span style="color:#66d9ef">AS</span> (
	<span style="color:#66d9ef">SELECT</span>
		employee_id,
		last_name,
		manager_id,
		<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">AS</span> n 
	<span style="color:#66d9ef">FROM</span>
		employees 
	<span style="color:#66d9ef">WHERE</span>
		employee_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> <span style="color:#75715e">-- 种子查询，找到他的下下属
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">UNION</span> <span style="color:#66d9ef">ALL</span>
	<span style="color:#66d9ef">SELECT</span>
		a.employee_id,
		a.last_name,
		a.manager_id,
		n <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> 
	<span style="color:#66d9ef">FROM</span>
		employees <span style="color:#66d9ef">AS</span> a
		<span style="color:#66d9ef">JOIN</span> cte <span style="color:#66d9ef">ON</span> ( a.manager_id <span style="color:#f92672">=</span> cte.employee_id ) <span style="color:#75715e">-- 递归查询，找出以递归公用表达式的人为领导的人
</span><span style="color:#75715e"></span>	) 
<span style="color:#66d9ef">SELECT</span>
	employee_id,
	last_name 
<span style="color:#66d9ef">FROM</span>
	cte 
<span style="color:#66d9ef">WHERE</span>
	n <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">3</span>;
</code></pre></div><p><strong>3.2.3 小结</strong></p>
<p>公用表表达式的作用是可以替代子查询，而且可以被多次引用。递归公用表表达式对查询有一个共同根节点的树形结构数据非常高效，可以轻松搞定其他查询方式难以处理的查询。</p>
<p>————————————————</p>
<p>版权声明：本文为CSDN博主「不入开发不工作」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。</p>
<p>原文链接：https://blog.csdn.net/weixin_46245201/article/details/123002895</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
